#include <stdint.h>
#include "stm32f407xx.h"

// USART2 (APB1) TX-> PA2  RX-> PA3
#define USART2_EN		(1U << 17)
#define CR1_TE			(1U << 3)	// UART Transmit en
#define CR1_UA			(1U << 13)	// UART UART en
#define SR_TXE			(1U << 6)

// GPIOA (AHB1)
#define GPIOA_EN		(1U << 0)

#define SYS_FREQ 		((uint32_t)16000000)
#define APB1_CLK		((uint32_t) SYS_FREQ)
#define UART_BAUDRATE 	((uint32_t)115200)

#define HSI_VALUE    ((uint32_t)16000000U) // Internal high speed oscillator
#define HSE_VALUE    ((uint32_t)8000000U)  // External high speed oscillator
#define LSI_VALUE    ((uint32_t)32000U)    // Internal low speed oscillator
#define LSE_VALUE    ((uint32_t)32768U)    // External low speed oscillator

void usart2_tx_init(void);
void usart2_write(int ch);

static void uart_set_baudrate(USART_TypeDef *USARTx, uint32_t PeriphClk, uint32_t baudRate);
static uint16_t compute_uart_bd(uint32_t PeriphClk, uint32_t baudRate);

uint8_t RCC_GetSYSCLKSource(void);

extern uint32_t SystemCoreClock;

int main() {

	while(1) {

	}
}


void usart2_tx_init(void) {
	// ----- gpio config -----
	// gpio clock
	RCC->AHB1ENR |= GPIOA_EN;
	// set gpio AF mode
	GPIOA->MODER = 0xA8000000;  // reset

	GPIOA->MODER |= (1U << 5); // 1
	GPIOA->MODER &= ~(1U << 4); // 0
	// set gpio speed
	GPIOA->OSPEEDR = 0x0C000000;  // reset
	GPIOA->OSPEEDR |= (0x2 << 4); // 0b10

	// set gpio AF type USART2 - AF7 - b0111
	GPIOA->AFR[0] |= (0x7 << 8); // pin A2
	//GPIOA->AFR[0] |= (0x7 << 12); // 	pin A3

	// ----- uart config -----
	// uart clock en
	RCC->APB1ENR |= USART2_EN;
	// uart baudrate
	uart_set_baudrate(USART2, APB1_CLK, UART_BAUDRATE);
	// uart transfer direction
	USART2->CR1 = 0x0; 	// reset
	USART2->CR1 |= CR1_TE; // transmit en
	// en uart
	USART2->CR1 |= CR1_UA;	// uart en
}

void usart2_write(int ch) {
	// is transmit data reg empty

	// write data to tx data reg

}

static void uart_set_baudrate(USART_TypeDef *USARTx, uint32_t PeriphClk, uint32_t baudRate) {
	USARTx->BRR = compute_uart_bd(PeriphClk, baudRate);
}

static uint16_t compute_uart_bd(uint32_t PeriphClk, uint32_t baudRate) {
	return ((PeriphClk + (baudRate / 2U))/baudRate);
}

uint8_t RCC_GetSYSCLKSource(void)
{
	return ((uint8_t)(RCC->CFGR & RCC_CFGR_SWS_Msk));

}

void set_clock_168(void) {
	uint8_t PLL_M = 8;
	uint8_t PLL_N = 336;
	uint8_t PLL_P = 2;
}
